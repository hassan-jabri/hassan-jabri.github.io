```psql
DROP TABLE IF EXISTS conditions;

CREATE TABLE conditions (
	START DATE,
	STOP DATE,
	PATIENT VARCHAR(1000),
	ENCOUNTER VARCHAR(1000),
	CODE VARCHAR(1000),
	DESCRIPTION VARCHAR(200)
);

DROP TABLE IF EXISTS encounters;

CREATE TABLE encounters (
	ID VARCHAR(100),
	START TIMESTAMP,
	STOP TIMESTAMP,
	PATIENT VARCHAR(100),
	ORGANIZATION VARCHAR(100),
	PROVIDER VARCHAR(100),
	PAYER VARCHAR(100),
	ENCOUNTERCLASS VARCHAR(100),
	CODE VARCHAR(100),
	DESCRIPTION VARCHAR(100),
	BASE_ENCOUNTER_COST FLOAT,
	TOTAL_CLAIM_COST FLOAT,
	PAYER_COVERAGE FLOAT,
	REASONCODE VARCHAR(100)
	--REASONDESCRIPTION VARCHAR(100)
);

DROP TABLE IF EXISTS immunizations;

CREATE TABLE immunizations (
	DATE TIMESTAMP,
	PATIENT VARCHAR(100),
	ENCOUNTER VARCHAR(100),
	CODE INT,
	DESCRIPTION VARCHAR(500)
	--BASE_COST float
);

DROP TABLE IF EXISTS patients;

CREATE TABLE patients (
	ID VARCHAR(100),
	BIRTHDATE DATE,
	DEATHDATE DATE,
	SSN VARCHAR(100),
	DRIVERS VARCHAR(100),
	PASSPORT VARCHAR(100),
	PREFIX VARCHAR(100),
	FIRST VARCHAR(100),
	LAST VARCHAR(100),
	SUFFIX VARCHAR(100),
	MAIDEN VARCHAR(100),
	MARITAL VARCHAR(100),
	RACE VARCHAR(100),
	ETHNICITY VARCHAR(100),
	GENDER VARCHAR(100),
	BIRTHPLACE VARCHAR(100),
	ADDRESS VARCHAR(100),
	CITY VARCHAR(100),
	STATE VARCHAR(100),
	COUNTY VARCHAR(100),
	FIPS INT,
	ZIP INT,
	LAT FLOAT,
	LON FLOAT,
	HEALTHCARE_EXPENSES FLOAT,
	HEALTHCARE_COVERAGE FLOAT,
	INCOME INT,
	MRN INT
);


SELECT * FROM conditions LIMIT 10;
SELECT * FROM encounters LIMIT 10;
SELECT * FROM immunizations LIMIT 10;
SELECT * FROM patients LIMIT 10;

/*
Objectives
Come up with flu shots dashboard for 2022 that does the following

1.) Total % of patients getting flu shots stratified by
   a.) Age
   b.) Race
   c.) County (On a Map)
   d.) Overall
2.) Running Total of Flu Shots over the course of 2022
3.) Total number of Flu shots given in 2022
4.) A list of Patients that show whether or not they received the flu shots
   
Requirements:

Patients must have been "Active at our hospital"
*/

WITH
	FLU_SHOT_2022 AS (
		SELECT
			PATIENT,
			MIN(DATE) AS EARLEST_FLU_SHOT_2022
		FROM
			IMMUNIZATIONS
		WHERE
			CODE = '5302'
			AND DATE BETWEEN '2022-01-01 00:00' AND '2022-12-31 23:59'
		GROUP BY
			PATIENT
	),
	ACTIVE_PATIENTS AS (
		SELECT
			DISTINCT PATIENT
		FROM
			ENCOUNTERS AS E
			JOIN PATIENTS AS P ON P.ID = E.PATIENT
		WHERE
			START BETWEEN '2020-01-01 00:00' AND '2022-12-31 23:59'
			AND P.DEATHDATE IS NULL
			AND EXTRACT(
				EPOCH FROM
					AGE ('2022-12-31', P.BIRTHDATE)
			)/2592000 >= 6
	)
	
SELECT
	P.ID,
	P.FIRST,
	P.LAST,
	P.BIRTHDATE,
	EXTRACT(YEAR FROM AGE('2022-12-31',P.BIRTHDATE)) as Age.
	P.RACE,
	P.COUNTY,
	FLU.EARLEST_FLU_SHOT_2022,
	CASE
		WHEN FLU.PATIENT IS NOT NULL THEN 1
		ELSE 0
	END AS FLU_SHOT_2022
FROM
	PATIENTS AS P
	LEFT JOIN FLU_SHOT_2022 AS FLU ON P.ID = FLU.PATIENT
WHERE
	P.ID in (SELECT PATIENT FROM active_patients)

```